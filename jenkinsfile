pipeline{
  agent {
    docker{ image 'node:latest'}
  }
  parameters{
        choice(name: 'DEPLOY_ENV', choices: ['int', 'stage', 'test', 'prod'], description:'Target environment')
  }
  environment {
        CI = 'true' 
  }
    stages{
            stage('Build application, run tests and publish test results'){
               
                steps{
                    sh 'npm install'
                    sh './jenkins/scripts/test.sh'
                }
                              
                post{
                    always {
                      
                   
                        publishHTML([
                            allowMissing: false, 
                            alwaysLinkToLastBuild: false, 
                            keepAll: false, 
                            reportDir: 'coverage/lcov-report', 
                            reportFiles: 'index.html', 
                            reportName: 'Test coverage', 
                            reportTitles: 'Test coverage'
                            ])
                    }
                }
                stage('Deliver') {
                  steps {
                    sh './jenkins/scripts/deliver.sh'
                    input message: 'Finished using the web site? (Click "Proceed" to continue)'
                    sh './jenkins/scripts/kill.sh'
                  }
                }
            } 
        }
}
